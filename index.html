<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Data Collection</title>
</head>

<body>
    <iframe id="cardinal_collection_iframe" name="collectionIframe" height="1" width="1"
        style="display: none;"></iframe>
    <form id="cardinal_collection_form" method="POST" target="collectionIframe">
        <input id="cardinal_collection_form_input" type="hidden" name="JWT">
    </form>

    <script>
        // // Safe Logger shim: ensures Logger.postMessage exists even when not provided by the host
        // // For Flutter WebViews the host may inject its own Logger; this shim forwards there when available
        // window.Logger = window.Logger || {
        //     postMessage: function (msg) {
        //         try {
        //             // If flutter_inappwebview is available, pass the message to the native handler
        //             if (window.flutter_inappwebview && typeof window.flutter_inappwebview.callHandler === 'function') {
        //                 try {
        //                     window.flutter_inappwebview.callHandler('log', typeof msg === 'object' ? JSON.stringify(msg) : String(msg));
        //                 } catch (e) {
        //                     // swallowing errors from host call to avoid breaking the page
        //                 }
        //             }
        //         } catch (e) {
        //             // ignore
        //         }
        //         // Always write to console for debugging in browsers
        //         try { console.log('[Logger]', msg); } catch (e) { }
        //     }
        // };

        // Function to receive configuration from Flutter
        window.receiveDataCollectionConfig = function (config) {
            const form = document.getElementById('cardinal_collection_form');
            const input = document.getElementById('cardinal_collection_form_input');

            form.action = config.deviceDataCollectionUrl;

            input.value = config.accessToken;

            form.submit();
        };

        // get public/external IP (falls back to empty string on error)
        async function getPublicIp() {
            try {
                const r = await fetch('https://api.ipify.org?format=json'); // or https://ipinfo.io/json
                if (!r.ok) return '';
                const j = await r.json();
                return j.ip || '';
            } catch (e) {
                return '';
            }
        }

        // gather device info (now async so it can await the IP)
        async function getDeviceInformation() {
            const publicIp = await getPublicIp();
            return {
                ipAddress: publicIp, // public IP (may be ISP NAT IP)
                fingerprintSessionId: '', // will be set from iframe response if needed
                httpAcceptBrowserValue: navigator.userAgent,
                httpAcceptContent: 'application/json',
                httpBrowserLanguage: navigator.language || navigator.userLanguage,
                httpBrowserJavaEnabled: typeof navigator.javaEnabled === 'function' ? navigator.javaEnabled() : false,
                httpBrowserJavaScriptEnabled: true,
                httpBrowserColorDepth: String(screen.colorDepth || ''),
                httpBrowserScreenHeight: String(screen.height || ''),
                httpBrowserScreenWidth: String(screen.width || ''),
                httpBrowserTimeDifference: String(new Date().getTimezoneOffset()),
                userAgentBrowserValue: navigator.userAgent
            };
        }

        // add a method to post messages using logger here, no extra checks needed
        // Logger is always defined at this point
        function logMessage(msg) {
            console.log('[logMessage]', JSON.stringify(msg));
            Logger.postMessage(msg);
        }
    </script>
</body>
<script>
    // Listen for the response from Cardinal
    window.addEventListener("message", async function (event) {
        if (event.origin === "https://centinelapistag.cardinalcommerce.com") {
            // Send the result back to Flutter
            logMessage({ ddc: JSON.stringify(event.data) });
        }

        const deviceInfo = await getDeviceInformation();
        logMessage({ deviceInfo: JSON.stringify(deviceInfo) });
    }, false);
</script>

</html>