<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step-Up Challenge</title>
</head>
<body>
    <iframe id="step-up-iframe" name="step-up-iframe" style="display: none;"></iframe>
    <form id="step-up-form" method="POST" target="step-up-iframe">
        <input type="hidden" name="JWT" value="">
        <input type="hidden" name="MD" value="">
    </form>

    <script>
        console.log('Script loaded: step-up page');
        window.receiveStepUpConfig = function(config) {
            console.log('receiveStepUpConfig called', config);
            const form = document.getElementById('step-up-form');
            const iframe = document.getElementById('step-up-iframe');
            console.log('Found form and iframe elements', { formExists: !!form, iframeExists: !!iframe });

            // Set form attributes
            console.log('Setting form.action to', config.stepUpUrl);
            form.action = config.stepUpUrl;
            console.log('form.action set to', form.action);

            // Set iframe dimensions
            console.log('Displaying iframe and setting dimensions to', { width: config.width, height: config.height });
            iframe.style.display = 'block';
            iframe.style.width = config.width + (typeof config.width === 'number' ? 'px' : '');
            iframe.style.height = config.height + (typeof config.height === 'number' ? 'px' : '');
            console.log('iframe style updated', { width: iframe.style.width, height: iframe.style.height, display: iframe.style.display });

            // Set form inputs
            console.log('Setting form inputs: JWT and MD');
            form.querySelector('input[name="JWT"]').value = config.pareq;
            form.querySelector('input[name="MD"]').value = config.accessToken;
            console.log('Form inputs set', { JWT: form.querySelector('input[name="JWT"]').value ? 'SET' : 'EMPTY', MD: form.querySelector('input[name="MD"]').value ? 'SET' : 'EMPTY' });

            // Listen for iframe load to know when submission finished
            try {
                iframe.addEventListener('load', function onIframeLoad() {
                    console.log('iframe load event fired');
                    iframe.removeEventListener('load', onIframeLoad);
                });
                console.log('Attached iframe load listener');
            } catch (e) {
                console.log('Could not attach iframe load listener', e && e.message);
            }

            // Submit the form
            console.log('Submitting the form now');
            form.submit();
            console.log('form.submit() called');
        }

        // Listen for step-up completion
        window.addEventListener("message", function(event) {
            console.log('message event received', { origin: event.origin, data: event.data });
            if (event.origin === "https://centinelapistag.cardinalcommerce.com") {
                console.log('Message origin matched expected origin');
                if (typeof StepUpHandler !== 'undefined' && StepUpHandler && typeof StepUpHandler.postMessage === 'function') {
                    console.log('StepUpHandler is available, sending otp challenge result');
                    try {
                        StepUpHandler.postMessage(JSON.stringify({ data: event.data }));
                        console.log('StepUpHandler.postMessage called');
                    } catch (e) {
                        console.log('Error calling StepUpHandler.postMessage', e && e.message);
                    }
                } else {
                    console.log('StepUpHandler not available');
                }
            } else {
                console.log('Message origin did not match expected origin', event.origin);
            }
        }, false);
    </script>
</body>
</html>